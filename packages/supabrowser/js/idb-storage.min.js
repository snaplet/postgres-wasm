var idbStorage=function(e){"use strict";function t({maxActiveReader:e=1/0}={}){let t,n,r=0;const o={read:e=>a(e,!1),write:e=>a(e,!0),length:0};return o;function a(a,s){const i=function({fn:e,block:t=!1,prev:n,next:r,q:o=c(),q2:a=(e.length?c():null)}){return{fn:e,block:t,prev:n,next:r,q:o,q2:a}}({fn:a,block:s});return n?(n.next=i,i.prev=n,n=i,t||(t=n)):t=n=i,o.length++,function a(){const c=t;if(!c||c.block&&c.prev||c.prev&&c.prev.block||r>=e)return;c.block||r++;t=c.next;let s;try{s=c.fn(c.q2&&c.q2.resolve)}catch(e){return c.q.reject(e),void i()}c.q2&&c.q2.promise.then(u);if(s&&s.then){const e=s.then(c.q.resolve,c.q.reject);c.q2||e.then(i)}else if(c.q.resolve(s),!c.q2)return void i();a();function i(){u()}function u(e){c.prev&&(c.prev.next=c.next),c.next&&(c.next.prev=c.prev),n===c&&(n=c.prev),c.block||r--,o.length--,e&&e(),a()}}(),i.q.promise}function c(){const e={};return e.promise=new Promise((t,n)=>{e.resolve=t,e.reject=n}),e}}const n="undefined"!=typeof navigator&&/iP(hone|(o|a)d);/.test(navigator.userAgent);function r(e){return new Promise((t,n)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>n(e.error||new Error("IDB request failed"))})}function o({name:e,version:t,onupgradeneeded:n,indexedDB:r=a()}){if(!e)throw new Error("missing storage name");if(!r)throw new Error("missing indexedDB");let o,c=0;return{use:s,startTransaction:function(e,t,n){return s(async r=>{const o=r.transaction(e,t),[a]=await Promise.all([n(o),new Promise((e,t)=>{o.oncomplete=()=>e(),o.onerror=()=>t(o.error||new Error("IDB transaction failed"))})]);return a})}};async function s(a){c++,o||(o=new Promise((o,a)=>{const c=r.open(e,t);c.onerror=()=>a(c.error||new Error("IDB open failed")),c.onsuccess=()=>o(c.result),c.onupgradeneeded=n}));const s=await o;let i,u;try{u=await a(s)}catch(e){i=e}if(--c||(s.close(),o=null),i)throw i;return u}}function a(){return"undefined"!=typeof indexedDB?indexedDB:"undefined"!=typeof webkitIndexedDB?webkitIndexedDB:"undefined"!=typeof mozIndexedDB?mozIndexedDB:"undefined"!=typeof OIndexedDB?OIndexedDB:"undefined"!=typeof msIndexedDB?msIndexedDB:null}return e.createIDBStorage=function({name:e,conflictAction:a="throw",indexedDB:c}={}){const s=o({indexedDB:c,name:e,version:1,onupgradeneeded:function(e){e.oldVersion<1&&(e.target.result.createObjectStore("metadata"),e.target.result.createObjectStore("resource"))}}),i=new Map,u=t(),l=function(e){const n=new Map;return{read:(e,t)=>r(e,t,"read"),write:(e,t)=>r(e,t,"write"),locks:n};async function r(r,o,a){const c=[],s=[];for(const o of r){let r=n.get(o);r||(r=t(e),n.set(o,r));const i={lock:r,scope:o,relase:null};s.push(r[a](e=>{i.release=e})),c.push(i)}let i;await Promise.all(s);try{i=o(o.length&&u)}catch(e){throw u(),e}return i&&i.then?(o.length||i.then(u,u),await i):(o.length||u(),i);function u(){for(const e of c)e.release(()=>{e.lock.length||n.delete(e.scope)});c.length=0}}}();let d;return function(e){for(const[t,n]of Object.entries(e))e[t]=(...e)=>(d||(d=s.startTransaction(["metadata"],"readonly",async e=>{const t=e.objectStore("metadata"),[n,o]=await Promise.all([r(t.getAllKeys()),r(t.getAll())]);for(let e=0;e<n.length;e++)i.set(n[e],o[e])})),d.then(()=>n(...e)));return e}({set:function(e,t,r){return u.read(()=>l.write([e],async()=>{const o=i.get(e);if(o){if("throw"===a)throw new Error(`idb-storage key conflict: ${e}`);if("ignore"===a)return o;if("stack"===a)return await w(e)}"function"==typeof t&&({resource:t,meta:r}=await t()),r||(r={}),r.stack=0,n&&t instanceof Blob?(r.blobType=t.type,t=await function(e){return new Promise((t,n)=>{const r=new FileReader;r.onload=()=>t(r.result),r.onerror=()=>n(r.error||new Error("failed to convert Blob to ArrayBuffer")),r.readAsArrayBuffer(e)})}(t)):r.blobType=null,r.size=t.size||t.byteLength||t.length;const c=Object.assign({},o,r);return await s.startTransaction(["metadata","resource"],"readwrite",n=>{const r=n.objectStore("metadata"),o=n.objectStore("resource");r.put(c,e),o.put(t,e)}),i.set(e,c),c}))},delete:function(e){return f([e])},deleteMany:function(e){return f(e)},get:function(e){return u.read(()=>l.read([e],async()=>{const t=i.get(e);if(!t)throw new Error(`missing key: ${e}`);const n=await s.startTransaction(["resource"],"readonly",t=>{return r(t.objectStore("resource").get(e))});return null!=t.blobType?new Blob([n],{type:t.blobType}):n}))},getMeta:function(e){return u.read(()=>l.read([e],()=>{const t=i.get(e);if(!t)throw new Error(`missing key: ${e}`);return t}))},stackUp:function(e){return u.read(()=>l.write([e],()=>w(e)))},clear:function(){return f([...i.keys()],!0)},clearAll:function(){return u.write(async()=>{await s.startTransaction(["metadata","resource"],"readwrite",e=>{const t=e.objectStore("metadata"),n=e.objectStore("resource");t.clear(),n.clear()}),i.clear()})}});function f(e,t=!1){return u.read(()=>l.write(new Set(e),async()=>{const n=new Map;await s.startTransaction(["metadata","resource"],"readwrite",r=>{const o=r.objectStore("metadata"),a=r.objectStore("resource");for(let r=0;r<e.length;r++){const c=i.get(e[r]);if(!c)continue;if(t||!c.stack){o.delete(e[r]),a.delete(e[r]),n.set(e[r],null);continue}const s=n.get(e[r])||Object.assign({},c);s.stack--,o.put(s,e[r]),n.set(e[r],s)}});for(const[e,t]of n.entries())t?i.set(e,t):i.delete(e)}))}async function w(e){const t=i.get(e);if(!t)throw new Error(`missing key: ${e}`);const n=Object.assign({},t);return n.stack++,await s.startTransaction(["metadata"],"readwrite",t=>{t.objectStore("metadata").put(n,e)}),i.set(e,n),n}},e}({});
